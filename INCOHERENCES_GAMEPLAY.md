# üîç Incoh√©rences et Probl√®mes de Gameplay D√©tect√©s

*Analyse du code - 7 Octobre 2025*

---

## ‚úÖ Probl√®mes R√©solus

### 1. **API Roblox Obsol√®te** ‚úÖ **R√âSOLU**
**Fichiers concern√©s:** `ResourceService.lua` (lignes 320-330), `FarmingService.lua` (ligne 156)

**Statut:** ‚úÖ **CORRIG√â**  
L'ancien syst√®me `Ray.new()` a √©t√© remplac√© par le nouveau `Workspace:Raycast()` avec `RaycastParams`.

```lua
-- Code actuel (CORRECT)
local raycastParams = RaycastParams.new()
raycastParams.FilterDescendantsInstances = {resource}
raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
local raycastResult = Workspace:Raycast(rayStart, rayDirection, raycastParams)
```

**Impact:** ‚úÖ Compatible avec les futures versions de Roblox

---

### 2. **Constructions sur les Ressources** ‚úÖ **R√âSOLU**
**Fichiers concern√©s:** `BuildingService.lua` (lignes 324-352)

**Statut:** ‚úÖ **CORRIG√â**  
La fonction `CheckPlacementValidity()` v√©rifie maintenant :
- ‚úÖ V√©rification 3: Distance minimale de 5 studs avec les ressources naturelles
- ‚úÖ V√©rification 4: Distance minimale de 3 studs avec les cultures
- ‚úÖ Les joueurs ne peuvent plus construire sur ou trop pr√®s des ressources/cultures

---

### 3. **Ressources Bloquent les Constructions** ‚úÖ **R√âSOLU**
**Fichiers concern√©s:** `ResourceService.lua` (lignes 205-238)

**Statut:** ‚úÖ **CORRIG√â**  
- ‚úÖ Fonction `IsValidResourcePosition()` v√©rifie distance minimale de 8 studs avec les constructions
- ‚úÖ Le respawn v√©rifie si une construction a √©t√© plac√©e (lignes 558-568)
- ‚úÖ Distance minimale entre ressources : 5 studs
- ‚úÖ La ressource est d√©finitivement retir√©e si position occup√©e

---

### 4. **Combat vs Structures** ‚úÖ **IMPL√âMENT√â**
**Fichiers concern√©s:** `CombatService.lua` (lignes 362-471), `BuildingService.lua` (lignes 923-944)

**Statut:** ‚úÖ **IMPL√âMENT√â**  
Le syst√®me de combat peut maintenant endommager les structures :
- ‚úÖ Fonction `AttackStructure()` dans CombatService
- ‚úÖ Fonction `DamageStructure()` dans BuildingService
- ‚úÖ V√©rification des permissions tribales
- ‚úÖ Calcul des d√©g√¢ts selon l'arme (structures prennent 50% des d√©g√¢ts d'arme)
- ‚úÖ Les outils font plus de d√©g√¢ts aux structures
- ‚úÖ RemoteEvent `AttackStructure` cr√©√© automatiquement

```lua
-- CombatService ligne 362-471
function CombatService:AttackStructure(attacker, structureId, hitPart)
    -- V√©rification cooldown, distance, permissions
    -- Calcul des d√©g√¢ts
    -- Appel √† BuildingService:DamageStructure()
end
```

---

## üî¥ Probl√®mes Critiques Restants

### 5. **Arrosage sans Consommation d'Eau**
**Fichier:** `FarmingService.lua` (lignes 319-346)

**Probl√®me:** Le syst√®me v√©rifie qu'on a `water_container` mais **ne le consomme jamais**

```lua
-- Ligne 320: V√©rification
if not self.inventoryService:HasItemInInventory(player, "water_container", 1) then

-- MAIS aucun RemoveItemFromInventory apr√®s !
```

**Impact:** Eau infinie pour l'agriculture

**Solution:** Ajouter apr√®s la ligne 339 :
```lua
self.inventoryService:RemoveItemFromInventory(player, "water_container", 1)
```

**Temps estim√©:** 15-30 minutes

---

### 6. **Multiplicateur d'Outils Non Appliqu√© Correctement**
**Fichier:** `ResourceService.lua` (ligne 491)

**Probl√®me:** Le multiplicateur de r√©colte est appliqu√© avec `math.floor()`

```lua
local amount = math.floor(baseAmount * toolMultiplier)
```

**Incoh√©rence:** 
- Si `baseAmount = 1` et `toolMultiplier = 1.5`
- R√©sultat = `floor(1.5)` = **1** (pas de bonus!)

**Solution:** Utiliser `math.ceil()` ou revoir la logique
```lua
local amount = math.ceil(baseAmount * toolMultiplier)
```

**Temps estim√©:** 15 minutes

---

### 7. **Cultures Perdues si Inventaire Plein**
**Fichiers concern√©s:** `FarmingService.lua` (lignes 294-312)

**Probl√®me:** Si l'inventaire est plein :
- **Ressources:** Restent r√©coltables (bon) ‚úÖ
- **Cultures:** Sont **d√©truites d√©finitivement** (ligne 307) ‚ùå

**Incoh√©rence:** Les cultures devraient rester r√©coltables comme les ressources

**Solution:** Remplacer ligne 307-312 par :
```lua
if success then
    -- D√©truire la culture
    self:DestroyCrop(cropId)
    return true
else
    self:SendNotification(player, "Inventaire plein, la plante reste pr√™te √† r√©colter", "warning")
    return false
end
```

**Temps estim√©:** 20 minutes

---

## üü° Probl√®mes Majeurs

### 8. **Pas de Protection des Ressources Tribales**
**Fichiers concern√©s:** `ResourceService.lua`, `TribeService.lua`

**Probl√®me:** Les ressources sur territoire tribal peuvent √™tre r√©colt√©es par **n'importe qui**

**Incoh√©rence:**
- Les constructions v√©rifient les permissions tribales (BuildingService ligne 354-377) ‚úÖ
- Les ressources ne v√©rifient **jamais** si on est sur un territoire tribal ‚ùå
- N'importe quel joueur peut piller les ressources d'une tribu

**Solution:** Ajouter dans `ResourceService:HandleResourceClick()` apr√®s ligne 378 :
```lua
-- V√©rifier la protection tribale
if self.tribeService then
    local resourcePosition = resourceInstance.PrimaryPart.Position
    local isOnTribalLand, tribeId = self.tribeService:IsPositionInTribeTerritory(resourcePosition)
    
    if isOnTribalLand then
        local playerTribeId = self.tribeService:GetPlayerTribeId(player)
        if playerTribeId ~= tribeId then
            self:SendNotification(player, "Cette ressource est sur un territoire tribal prot√©g√©", "error")
            return
        end
    end
end
```

**Temps estim√©:** 2-3 heures (n√©cessite ajout de fonction dans TribeService)

---

### 9. **Cultures Invincibles**
**Fichier:** `FarmingService.lua` (ligne 97)

**Probl√®me:** Les cultures ont un attribut `health = 100` mais **aucun syst√®me ne l'utilise**

**Incoh√©rence:**
- Les cultures ne peuvent pas √™tre endommag√©es
- Un ennemi ne peut pas d√©truire les cultures d'une tribu adverse
- Pas de syst√®me de pi√©tinement ou de d√©g√¢ts environnementaux

**Solution:** Impl√©menter dans `FarmingService` :
```lua
function FarmingService:DamageCrop(cropId, damage, cause)
    local cropData = self.plantedCrops[cropId]
    if not cropData then return false end
    
    cropData.health = math.max(0, cropData.health - damage)
    
    if cropData.health <= 0 then
        self:DestroyCrop(cropId)
        return true
    end
    
    return true
end
```

Et connecter avec `CombatService` pour permettre attaques sur cultures.

**Temps estim√©:** 1-2 heures

---

### 10. **Syst√®me de Sommeil Non Impl√©ment√©**
**Fichiers concern√©s:** `BuildingService.lua` (lignes 664-679), `SurvivalService.lua` (lignes 556-618)

**Probl√®me:** Les lits d√©clenchent un √©v√©nement `PlayerAction:FireClient(player, "sleep")` mais :
- `SurvivalService` a des fonctions `StartSleeping` et `StopSleeping` ‚úÖ
- Elles sont pr√©sentes mais **pas connect√©es aux lits** ‚ùå
- L'√©v√©nement c√¥t√© client n'est **pas g√©r√©** ‚ùå
- Les lits ont un attribut `sleepQuality` inutilis√©

**Solution:** Connecter `BuildingService:HandleBedInteraction()` avec `SurvivalService:StartSleeping()` :
```lua
-- Dans BuildingService ligne 677
function BuildingService:HandleBedInteraction(player, structureId)
    local structureData = self.structuresById[structureId]
    if not structureData then return end
    
    if not self:CanPlayerInteractWithStructure(player, structureId) then
        self:SendNotification(player, "Vous n'avez pas acc√®s √† ce lit", "error")
        return
    end
    
    -- Appeler le SurvivalService
    if self.survivalService then
        self.survivalService:StartSleeping(player, structureId)
    end
end
```

**Temps estim√©:** 2-3 heures (inclut impl√©mentation c√¥t√© client)

---

## üü¢ Probl√®mes Mineurs

### 11. **R√©g√©n√©ration de Sant√© Non Li√©e √† la Survie**
**Fichier:** `CombatService.lua` (lignes 601-609)

**Probl√®me:** R√©g√©n√©ration hors combat : **0.5 HP/seconde** = r√©cup√©ration compl√®te en **200 secondes (3min 20s)**

**Incoh√©rence avec:** Le syst√®me de survie qui g√®re faim/soif/√©nergie devrait influencer la r√©g√©n√©ration

**Suggestion:** 
```lua
-- Dans CombatService:UpdateCombatStates() ligne 602
if not combatData.isInCombat and combatData.currentHealth < combatData.maxHealth then
    local regenRate = 0.5
    
    -- Modifier selon la survie
    if self.survivalService then
        local survivalData = self.survivalService.playerSurvivalData[userId]
        if survivalData then
            -- Ralentir si faim < 30%
            if survivalData.hunger < 30 then
                regenRate = regenRate * 0.5
            end
            -- Arr√™ter si soif < 20%
            if survivalData.thirst < 20 then
                regenRate = 0
            end
        end
    end
    
    combatData.currentHealth = math.min(combatData.maxHealth, combatData.currentHealth + regenRate)
end
```

**Temps estim√©:** 1 heure

---

### 12. **Portes avec Animation Bugg√©e**
**Fichier:** `BuildingService.lua` (lignes 579-628)

**Probl√®me:** L'animation d'ouverture de porte utilise une interpolation qui peut causer des bugs si spam-clic

```lua
-- Ligne 617: Interpolation avec Lerp
connection = game:GetService("RunService").Heartbeat:Connect(function()
    -- Si le joueur spam-clique, plusieurs animations peuvent se chevaucher
end)
```

**Solution:** Ajouter un debounce :
```lua
-- Ajouter attribut
doorModel:SetAttribute("DoorAnimating", false)

-- Dans MouseClick
if doorModel:GetAttribute("DoorAnimating") then return end
doorModel:SetAttribute("DoorAnimating", true)

-- √Ä la fin de l'animation
doorModel:SetAttribute("DoorAnimating", false)
```

**Temps estim√©:** 30 minutes

---

### 13. **Pas de Limite de Constructions par Joueur**
**Fichier:** `BuildingService.lua`

**Probl√®me:** Aucune limite sur le nombre de structures qu'un joueur peut construire

**Impact:**
- Spam de constructions possible
- Lag serveur si un joueur construit 1000+ structures
- Pas de gestion m√©moire

**Solution:** Ajouter `maxStructuresPerPlayer = 100` dans `GameSettings` et v√©rifier dans `PlaceBuilding()`

**Temps estim√©:** 1 heure

---

### 14. **Pas de Collision entre Joueurs et Cultures**
**Fichier:** `FarmingService.lua` (ligne 190)

```lua
primaryPart.CanCollide = false
```

**Probl√®me:** Les joueurs traversent les cultures

**Suggestion:** Les plantes matures devraient avoir une collision l√©g√®re
```lua
-- Adapter selon le stade
if cropData.stage >= 4 then
    primaryPart.CanCollide = true
else
    primaryPart.CanCollide = false
end
```

**Temps estim√©:** 30 minutes

---

### 15. **Durabilit√© des Structures Jamais D√©grad√©e Naturellement**
**Fichier:** `BuildingService.lua` (lignes 907-921)

**Probl√®me:** La boucle `CheckDamagedStructures()` v√©rifie les structures endommag√©es mais **rien ne les endommage naturellement**

**Manque:**
- Pas de d√©gradation temporelle
- Pas de d√©g√¢ts m√©t√©orologiques
- Pas d'impact des saisons
- Seules les attaques de joueurs causent des d√©g√¢ts

**Suggestion:** Ajouter d√©gradation progressive (optionnel pour alpha)
```lua
-- Dans BuildingService:CheckDamagedStructures()
for structureId, structureData in pairs(self.structuresById) do
    local age = os.time() - structureData.creationTime
    local daysOld = age / (24 * 60 * 60)
    
    -- D√©gradation de 1 point par jour
    if daysOld > 1 then
        self:DamageStructure(structureId, 1, "natural_decay")
        structureData.creationTime = os.time() -- R√©initialiser
    end
end
```

**Temps estim√©:** 2-3 heures

---

## üìä Tableau R√©capitulatif

| # | Probl√®me | S√©v√©rit√© | Statut | Temps Fix | Bloquant Alpha ? |
|---|----------|----------|--------|-----------|------------------|
| 1 | API Obsol√®te | üü¢ R√©solu | ‚úÖ | - | - |
| 2 | Construction sur ressources | üü¢ R√©solu | ‚úÖ | - | - |
| 3 | Respawn sur constructions | üü¢ R√©solu | ‚úÖ | - | - |
| 4 | Combat vs Structures | üü¢ R√©solu | ‚úÖ | - | - |
| 5 | Eau infinie arrosage | üî¥ Critique | ‚ùå | 30 min | ‚úÖ OUI |
| 6 | Multiplicateur floor() | üî¥ Critique | ‚ùå | 15 min | ‚úÖ OUI |
| 7 | Cultures perdues inventaire plein | üî¥ Critique | ‚ùå | 20 min | ‚úÖ OUI |
| 8 | Pas de protection tribale | üü° Majeur | ‚ùå | 2-3h | ‚ö†Ô∏è Recommand√© |
| 9 | Cultures invincibles | üü° Majeur | ‚ùå | 1-2h | ‚ö†Ô∏è Recommand√© |
| 10 | Sommeil non impl√©ment√© | üü° Majeur | ‚ö†Ô∏è | 2-3h | ‚ö†Ô∏è Recommand√© |
| 11 | Regen trop rapide | üü¢ Mineur | ‚ùå | 1h | ‚ùå NON |
| 12 | Animation portes | üü¢ Mineur | ‚ùå | 30 min | ‚ùå NON |
| 13 | Pas de limite constructions | üü¢ Mineur | ‚ùå | 1h | ‚ùå NON |
| 14 | Cultures sans collision | üü¢ Mineur | ‚ùå | 30 min | ‚ùå NON |
| 15 | Durabilit√© jamais d√©grad√©e | üü¢ Mineur | ‚ùå | 2-3h | ‚ùå NON |

---

## üéØ Recommandations Prioritaires

### Court Terme (Alpha Jouable - OBLIGATOIRE)
1. ‚úÖ ~~Corriger le spawn de ressources sur constructions~~ **FAIT**
2. ‚úÖ ~~Emp√™cher les constructions sur les ressources existantes~~ **FAIT**
3. ‚úÖ ~~Impl√©menter combat vs structures~~ **FAIT**
4. ‚ùå **Ajouter la consommation d'eau pour l'arrosage** (30 min)
5. ‚ùå **Corriger le multiplicateur d'outils** (15 min)
6. ‚ùå **Emp√™cher perte de cultures si inventaire plein** (20 min)

**Total temps : 1 heure 5 minutes** ‚è∞

### Moyen Terme (Alpha Jouable - RECOMMAND√â)
7. ‚ùå Ajouter la protection territoriale des ressources (2-3h)
8. ‚ùå Permettre la destruction des cultures (1-2h)
9. ‚ùå Finaliser le syst√®me de sommeil (2-3h)
10. ‚ùå Lier r√©g√©n√©ration √† la survie (1h)

**Total temps : 6-9 heures** ‚è∞

### Long Terme (Post-Alpha)
11. Syst√®me de d√©gradation naturelle des structures
12. Int√©gration compl√®te combat-survie-farming
13. Limites et optimisations de performance
14. Syst√®me de saisons affectant tous les syst√®mes

---

## ‚úÖ Progr√®s R√©alis√©s

**4 probl√®mes critiques r√©solus depuis la derni√®re analyse :**
1. ‚úÖ API Ray.new() remplac√©e par Raycast
2. ‚úÖ Protection contre construction sur ressources
3. ‚úÖ Protection contre respawn sur constructions
4. ‚úÖ Combat peut endommager les structures

**Excellente progression ! Le code utilise maintenant les API modernes.**

---

*Document g√©n√©r√© automatiquement suite √† l'analyse du code*  
*Derni√®re analyse : 7 Octobre 2025*
